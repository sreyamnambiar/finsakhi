import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useTranslation } from 'react-i18next';
import { Mic, Volume2, VolumeX, ArrowLeft, Loader2 } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { FinSakhiMascot } from '@/components/FinSakhiMascot';
import { geminiChat } from '@/lib/gemini';
import { speechService } from '@/lib/speech';
import { toast } from 'sonner';

const VoiceAssistant = () => {
  const { t } = useTranslation();
  const navigate = useNavigate();
  const [isListening, setIsListening] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const [transcript, setTranscript] = useState('');
  const [response, setResponse] = useState('');
  const [language, setLanguage] = useState<'en-US' | 'hi-IN' | 'ta-IN'>('en-US');

  const handleInterimResult = useCallback((text: string) => {
    console.log('ЁЯОд Interim result:', text);
    setInterimText(text);
  }, []);

  const handleFinalResult = useCallback(async (text: string) => {
    console.log('ЁЯОд Final result received:', text);
    
    if (!text.trim()) {
      console.log('тЪая╕П Empty text, ignoring');
      toast.warning('No speech detected. Please try again.');
      return;
    }
    
    setInterimText('');
    setDebugInfo(`Processing: "${text}"`);
    
    // Add user message to conversation
    const userMessage: Conversation = {
      id: `user-${Date.now()}`,
      speaker: 'user',
      text: text.trim(),
      timestamp: new Date()
    };
    
    console.log('ЁЯТм Adding user message:', userMessage);
    setConversation(prev => [...prev, userMessage]);
    
    // Show processing indicator
    setIsProcessing(true);
    
    try {
      console.log('ЁЯдЦ Sending to Gemini AI...');
      
      // Tell Gemini to respond in the same language
      const languagePrompt = language === 'hi-IN' ? 'Respond in Hindi.' : 
                            language === 'ta-IN' ? 'Respond in Tamil.' : 
                            'Respond in English.';
      
      const prompt = `${text}\n\n${languagePrompt}`;
      
      const reply = await geminiChat.sendMessage(prompt);
      
      console.log('ЁЯдЦ Gemini response received');
      
      // Add assistant response
      const assistantMessage: Conversation = {
        id: `assistant-${Date.now()}`,
        speaker: 'assistant',
        text: reply,
        timestamp: new Date()
      };
      
      setConversation(prev => [...prev, assistantMessage]);
      
      // Speak the response
      console.log('ЁЯФК Speaking response...');
      await speakMessage(reply);
      
      // Auto-listen for next input
      if (autoListen) {
        console.log('ЁЯФД Auto-listen enabled, restarting...');
        setTimeout(() => {
          startVoiceInput();
        }, 1500);
      }
    } catch (error) {
      console.error('тЭМ AI processing error:', error);
      
      setDebugInfo(`Error: ${error instanceof Error ? error.message : 'Unknown error'}`);
      
      const errorMessage = language === 'hi-IN' ? 
        "рдХреНрд╖рдорд╛ рдХрд░реЗрдВ, рдореБрдЭреЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рджреЗрдиреЗ рдореЗрдВ рд╕рдорд╕реНрдпрд╛ рд╣реЛ рд░рд╣реА рд╣реИред рдХреГрдкрдпрд╛ рдлрд┐рд░ рд╕реЗ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред" :
        language === 'ta-IN' ? 
        "рооройрпНройро┐роХрпНроХро╡рпБроорпН, рокродро┐ро▓рпН роЕро│ро┐рокрпНрокродро┐ро▓рпН роЪро┐роХрпНроХро▓рпН роЙро│рпНро│родрпБ. родропро╡рпБ роЪрпЖропрпНродрпБ роорпАрогрпНроЯрпБроорпН роорпБропро▒рпНроЪро┐роХрпНроХро╡рпБроорпН." :
        "Sorry, I'm having trouble responding. Please try again.";
      
      setConversation(prev => [...prev, {
        id: `error-${Date.now()}`,
        speaker: 'assistant',
        text: errorMessage,
        timestamp: new Date(),
        error: true
      }]);
      
      toast.error('Failed to process request. Please try again.');
    } finally {
      setIsProcessing(false);
      setDebugInfo('Ready for next input');
    }
  }, [autoListen, language]);

  const handleSpeechError = useCallback((error: string) => {
    console.error('ЁЯОд Speech error:', error);
    setDebugInfo(`Speech error: ${error}`);
    
    setIsListening(false);
    
    const errorMessages = {
      'not-allowed': 'Microphone permission denied. Please allow access in browser settings.',
      'permission-denied': 'Microphone permission denied. Please allow access in browser settings.',
      'not-supported': 'Voice features require Chrome or Edge browser.',
      'no-speech': 'No speech detected. Please speak louder and clearer.',
      'network': 'Network error. Please check your internet connection.',
      'start-failed': 'Failed to start voice recognition. Please try again.',
      'default': 'Voice recognition error. Please try again.'
    };
    
    toast.error(errorMessages[error as keyof typeof errorMessages] || errorMessages.default);
    
    // If auto-listen is on and we got an error, try to restart (except for permission errors)
    if (autoListen && error !== 'not-allowed' && error !== 'permission-denied') {
      setTimeout(() => {
        startVoiceInput();
      }, 3000);
    }
  }, [autoListen]);

  const startVoiceInput = useCallback(() => {
    console.log('ЁЯОд Starting voice input...');
    
    if (isListening) {
      console.log('ЁЯОд Already listening, stopping...');
      realTimeSpeechService.stopListening();
      setIsListening(false);
      setInterimText('');
      return;
    }

    // Check if already processing
    if (isProcessing || isSpeaking) {
      console.log('тЪая╕П Cannot start listening - busy');
      toast.warning('Please wait for current action to complete');
      return;
    }

    setIsListening(true);
    setInterimText('');
    setDebugInfo('Listening...');

    // Clear any previous timeout
    if (speechTimeoutRef.current) {
      clearTimeout(speechTimeoutRef.current);
    }

    // Set timeout for no speech
    speechTimeoutRef.current = setTimeout(() => {
      if (isListening) {
        console.log('тП░ No speech timeout');
        handleSpeechError('no-speech');
        setIsListening(false);
      }
    }, 10000);

    // Start listening
    realTimeSpeechService.startListening(
      (text) => {
        console.log('тЬЕ Final callback received:', text);
        if (speechTimeoutRef.current) {
          clearTimeout(speechTimeoutRef.current);
        }
        setIsListening(false);
        handleFinalResult(text);
      },
      (error) => {
        console.log('тЭМ Error callback received:', error);
        if (speechTimeoutRef.current) {
          clearTimeout(speechTimeoutRef.current);
        }
        setIsListening(false);
        handleSpeechError(error);
      },
      language,
      (interim) => {
        console.log('ЁЯОд Interim callback:', interim);
        handleInterimResult(interim);
      }
    );
  }, [isListening, isProcessing, isSpeaking, language, handleFinalResult, handleSpeechError, handleInterimResult]);

  const speakMessage = async (text: string) => {
    if (!text) {
      console.log('тЪая╕П No text to speak');
      return;
    }
    
    console.log('ЁЯФК Starting speech synthesis...');
    
    try {
      setIsSpeaking(true);
      const voiceLang = language === 'en-US' ? 'english' : 
                       language === 'hi-IN' ? 'hindi' : 'tamil';
      console.log(`ЁЯФК Language: ${voiceLang}`);
      
      await realTimeSpeechService.speak(text, voiceLang);
      console.log('тЬЕ Speech synthesis completed');
    } catch (error) {
      console.error('тЭМ Speech synthesis error:', error);
      toast.error('Failed to speak response');
    } finally {
      setIsSpeaking(false);
      console.log('ЁЯФК Speech synthesis ended');
    }
  };

  const stopSpeaking = () => {
    console.log('тП╣я╕П Stopping speech...');
    realTimeSpeechService.stopSpeaking();
    setIsSpeaking(false);
  };

  const cycleLanguage = () => {
    const langs: Array<'en-US' | 'hi-IN' | 'ta-IN'> = ['en-US', 'hi-IN', 'ta-IN'];
    const currentIndex = langs.indexOf(language);
    const nextIndex = (currentIndex + 1) % langs.length;
    const nextLang = langs[nextIndex];
    
    setLanguage(nextLang);
    
    const langNames = { 
      'en-US': 'English', 
      'hi-IN': 'рд╣рд┐рдВрджреА', 
      'ta-IN': 'родрооро┐ро┤рпН' 
    };
    
    toast.success(`Language changed to ${langNames[nextLang]}`);
    
    // Speak language change
    const changeMsg = language === 'hi-IN' ? 'рднрд╛рд╖рд╛ рдмрджрд▓ рдЧрдИ рд╣реИ' :
                     language === 'ta-IN' ? 'роорпКро┤ро┐ рооро╛ро▒рпНро▒рокрпНрокроЯрпНроЯродрпБ' :
                     'Language changed';
    
    realTimeSpeechService.speak(changeMsg, nextLang === 'hi-IN' ? 'hindi' : nextLang === 'ta-IN' ? 'tamil' : 'english');
  };

  const clearConversation = () => {
    console.log('ЁЯЧСя╕П Clearing conversation');
    setConversation([]);
    setInterimText('');
    setDebugInfo('Conversation cleared');
    
    // Add new welcome message
    const welcomeMessages = {
      'en-US': "Hello! I'm FinSakhi, ready to help you with banking, savings, or UPI.",
      'hi-IN': "рдирдорд╕реНрддреЗ! рдореИрдВ FinSakhi рд╣реВрдВ, рдЖрдкрдХреА рдмреИрдВрдХрд┐рдВрдЧ, рдмрдЪрдд рдпрд╛ UPI рдореЗрдВ рдорджрдж рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реВрдВред",
      'ta-IN': "ро╡рогроХрпНроХроорпН! роиро╛ройрпН FinSakhi, ро╡роЩрпНроХро┐, роЪрпЗрооро┐рокрпНрокрпБ роЕро▓рпНро▓родрпБ UPI рокро▒рпНро▒ро┐ роЙроЩрпНроХро│рпБроХрпНроХрпБ роЙродро╡ родропро╛ро░ро╛роХ роЙро│рпНро│рпЗройрпН."
    };
    
    setConversation([{
      id: 'welcome',
      speaker: 'assistant',
      text: welcomeMessages[language],
      timestamp: new Date()
    }]);
  };

  // Quick questions in different languages
  const quickQuestions = [
    // English
    { text: "Bank account documents", query: "What documents do I need to open a bank account?", lang: 'en-US' },
    { text: "Create UPI ID", query: "How to create UPI ID?", lang: 'en-US' },
    { text: "Savings schemes", query: "Best savings schemes for women?", lang: 'en-US' },
    
    // Hindi
    { text: "рдмреИрдВрдХ рдЦрд╛рддрд╛ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝", query: "рдмреИрдВрдХ рдЦрд╛рддрд╛ рдЦреЛрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдХреМрди рд╕реЗ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдЪрд╛рд╣рд┐рдП?", lang: 'hi-IN' },
    { text: "UPI рдЖрдИрдбреА рдмрдирд╛рдПрдВ", query: "UPI рдЖрдИрдбреА рдХреИрд╕реЗ рдмрдирд╛рдПрдВ?", lang: 'hi-IN' },
    { text: "рдмрдЪрдд рдпреЛрдЬрдирд╛рдПрдВ", query: "рдорд╣рд┐рд▓рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рдЕрдЪреНрдЫреА рдмрдЪрдд рдпреЛрдЬрдирд╛рдПрдВ рдХреМрди рд╕реА рд╣реИрдВ?", lang: 'hi-IN' },
    
    // Tamil
    { text: "ро╡роЩрпНроХро┐роХрпН роХрогроХрпНроХрпБ роЖро╡рогроЩрпНроХро│рпН", query: "ро╡роЩрпНроХро┐роХрпН роХрогроХрпНроХрпБ родро┐ро▒роХрпНроХ роОройрпНрой роЖро╡рогроЩрпНроХро│рпН родрпЗро╡рпИ?", lang: 'ta-IN' },
    { text: "UPI роРроЯро┐ роЙро░рпБро╡ро╛роХрпНроХ", query: "UPI роРроЯро┐ роОрокрпНрокроЯро┐ роЙро░рпБро╡ро╛роХрпНроХрпБро╡родрпБ?", lang: 'ta-IN' },
    { text: "роЪрпЗрооро┐рокрпНрокрпБродрпН родро┐роЯрпНроЯроЩрпНроХро│рпН", query: "рокрпЖрогрпНроХро│рпБроХрпНроХро╛рой роЪро┐ро▒роирпНрод роЪрпЗрооро┐рокрпНрокрпБродрпН родро┐роЯрпНроЯроЩрпНроХро│рпН роОро╡рпИ?", lang: 'ta-IN' },
  ];

  // Filter questions by current language
  const filteredQuestions = quickQuestions.filter(q => q.lang === language).slice(0, 3);

  const formatTime = (date: Date) => {
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  };

  // Manual test function
  const testVoiceInput = () => {
    const testText = language === 'hi-IN' ? "рдмреИрдВрдХ рдЦрд╛рддрд╛ рдХреИрд╕реЗ рдЦреЛрд▓реЗрдВ?" :
                    language === 'ta-IN' ? "ро╡роЩрпНроХро┐роХрпН роХрогроХрпНроХрпИ роОрокрпНрокроЯро┐ родро┐ро▒роХрпНроХро▓ро╛роорпН?" :
                    "How to open a bank account?";
    
    console.log('ЁЯзк Testing with text:', testText);
    handleFinalResult(testText);
  };

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-br from-background via-primary/5 to-background">
      {/* Header */}
      <motion.header
        className="sticky top-0 z-50 px-5 pt-6 pb-4 bg-background/80 backdrop-blur-lg border-b"
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Button 
              variant="ghost" 
              size="icon"
              onClick={() => navigate('/')}
              className="rounded-full"
            >
              <ArrowLeft size={20} />
            </Button>
            <FinSakhiMascot size="sm" />
            <div>
              <h1 className="text-xl font-bold text-foreground">
                {language === 'hi-IN' ? 'рд╡реЙрдпрд╕ рдЕрд╕рд┐рд╕реНрдЯреЗрдВрдЯ' : 
                 language === 'ta-IN' ? 'роХрпБро░ро▓рпН роЙродро╡ро┐ропро╛ро│ро░рпН' : 
                 'Voice Assistant'}
              </h1>
              <p className="text-sm text-muted-foreground">
                {language === 'hi-IN' ? 'FinSakhi рд╕реЗ рдмрд╛рдд рдХрд░реЗрдВ' : 
                 language === 'ta-IN' ? 'FinSakhi роЙроЯройрпН рокрпЗроЪрпБроЩрпНроХро│рпН' : 
                 'Speak naturally with FinSakhi'}
              </p>
            </div>
          </div>
          
          <div className="flex items-center gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={testVoiceInput}
              className="gap-2"
            >
              ЁЯзк {language === 'hi-IN' ? 'рдЯреЗрд╕реНрдЯ' : 
                  language === 'ta-IN' ? 'роЪрпЛродройрпИ' : 
                  'Test'}
            </Button>
          </div>
        </div>
      </motion.header>

      {/* Debug Panel */}
      {debugInfo && (
        <Alert className="mx-4 mt-4 bg-muted">
          <AlertCircle className="h-4 w-4" />
          <AlertDescription className="font-mono text-xs">
            {debugInfo}
          </AlertDescription>
        </Alert>
      )}

      {/* Main Content */}
      <div className="flex-1 flex flex-col max-w-4xl mx-auto w-full px-4 py-6">
        {/* Conversation Area */}
        <Card className="flex-1 mb-6 overflow-hidden">
          <CardContent className="p-6 h-full flex flex-col">
            <div className="flex-1 overflow-y-auto max-h-[50vh] space-y-4">
              {conversation.map((msg) => (
                <motion.div
                  key={msg.id}
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  className={`flex ${msg.speaker === 'user' ? 'justify-end' : 'justify-start'}`}
                >
                  <div className={`max-w-[80%] rounded-2xl p-4 ${
                    msg.speaker === 'user' 
                      ? 'bg-primary text-primary-foreground rounded-tr-none' 
                      : msg.error
                      ? 'bg-destructive/20 text-destructive-foreground rounded-tl-none'
                      : 'bg-muted rounded-tl-none'
                  } ${msg.isInterim ? 'opacity-70 italic' : ''}`}>
                    <div className="flex items-center gap-2 mb-1">
                      {msg.speaker === 'assistant' ? (
                        <Bot size={12} className={msg.error ? 'text-destructive' : 'opacity-70'} />
                      ) : (
                        <Mic size={12} className="opacity-70" />
                      )}
                      <span className="text-xs opacity-70">
                        {msg.speaker === 'assistant' ? 'FinSakhi' : 
                         language === 'hi-IN' ? 'рдЖрдк' : 
                         language === 'ta-IN' ? 'роирпАроЩрпНроХро│рпН' : 
                         'You'}
                        {msg.isInterim && ' (typing...)'}
                        {msg.error && ' (error)'}
                      </span>
                      <span className="text-xs opacity-50 ml-auto">
                        {formatTime(msg.timestamp)}
                      </span>
                    </div>
                    <p className={msg.isInterim ? 'italic' : ''}>
                      {msg.text}
                    </p>
                  </div>
                </motion.div>
              ))}
              
              {/* Interim text bubble */}
              {interimText && (
                <motion.div
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  className="flex justify-end"
                >
                  <div className="max-w-[80%] rounded-2xl p-4 bg-primary/20 border border-primary/30 rounded-tr-none">
                    <div className="flex items-center gap-2 mb-1">
                      <Mic size={12} className="animate-pulse" />
                      <span className="text-xs">
                        {language === 'hi-IN' ? 'рд╕реБрди рд░рд╣рд╛ рд╣реВрдВ...' : 
                         language === 'ta-IN' ? 'роХрпЗроЯрпНроХро┐ро▒родрпБ...' : 
                         'Listening...'}
                      </span>
                      <div className="flex gap-1 ml-2">
                        <div className="w-1 h-2 bg-primary rounded-full animate-pulse" />
                        <div className="w-1 h-3 bg-primary rounded-full animate-pulse" style={{ animationDelay: '0.1s' }} />
                        <div className="w-1 h-4 bg-primary rounded-full animate-pulse" style={{ animationDelay: '0.2s' }} />
                      </div>
                    </div>
                    <p className="italic">{interimText}</p>
                  </div>
                </motion.div>
              )}
              
              <div ref={conversationEndRef} />
            </div>
          </CardContent>
        </Card>

        {/* Quick Questions */}
        {filteredQuestions.length > 0 && (
          <div className="mb-4">
            <h3 className="text-sm font-medium text-muted-foreground mb-2">
              {language === 'hi-IN' ? 'рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ:' : 
               language === 'ta-IN' ? 'роорпБропро▒рпНроЪро┐роХрпНроХ:' : 
               'Try asking:'}
            </h3>
            <div className="flex flex-wrap gap-2">
              {filteredQuestions.map((q, i) => (
                <Button
                  key={i}
                  variant="outline"
                  size="sm"
                  onClick={() => handleFinalResult(q.query)}
                  className="gap-2"
                  disabled={isProcessing || isSpeaking || isListening}
                >
                  {q.text}
                </Button>
              ))}
            </div>
          </div>
        )}

        {/* Control Bar */}
        <div className="flex flex-col items-center gap-6">
          {/* Status Indicators */}
          <div className="flex items-center gap-4">
            <div className="flex flex-col items-center">
              <div className={`w-3 h-3 rounded-full ${isListening ? 'bg-red-500 animate-pulse' : 'bg-gray-400'}`} />
              <span className="text-xs mt-1">
                {language === 'hi-IN' ? 'рдорд╛рдЗрдХ' : 
                 language === 'ta-IN' ? 'роорпИроХрпН' : 
                 'Mic'}
              </span>
            </div>
            <div className="flex flex-col items-center">
              <div className={`w-3 h-3 rounded-full ${isSpeaking ? 'bg-green-500 animate-pulse' : 'bg-gray-400'}`} />
              <span className="text-xs mt-1">
                {language === 'hi-IN' ? 'рд╕реНрдкреАрдХрд░' : 
                 language === 'ta-IN' ? 'ро╕рпНрокрпАроХрпНроХро░рпН' : 
                 'Speaker'}
              </span>
            </div>
            <div className="flex flex-col items-center">
              <div className={`w-3 h-3 rounded-full ${isProcessing ? 'bg-blue-500 animate-spin' : 'bg-gray-400'}`} />
              <span className="text-xs mt-1">AI</span>
            </div>
            
            <Button
              variant="outline"
              size="sm"
              onClick={cycleLanguage}
              className="gap-2 hover:bg-accent"
            >
              <Globe size={14} />
              {language === 'en-US' ? 'English' : language === 'hi-IN' ? 'рд╣рд┐рдВрджреА' : 'родрооро┐ро┤рпН'}
            </Button>
            
            <div className="flex items-center gap-2">
              <span className="text-xs">
                {language === 'hi-IN' ? 'рдСрдЯреЛ рд▓рд┐рд╕рди:' : 
                 language === 'ta-IN' ? 'родро╛ройро╛роХ роХрпЗро│рпН:' : 
                 'Auto-listen:'}
              </span>
              <div 
                className={`w-10 h-5 flex items-center rounded-full p-1 cursor-pointer transition-colors ${autoListen ? 'bg-primary' : 'bg-muted'}`}
                onClick={() => {
                  setAutoListen(!autoListen);
                  toast.success(
                    autoListen ? 
                    (language === 'hi-IN' ? 'рдСрдЯреЛ рд▓рд┐рд╕рди рдЕрдХреНрд╖рдо' : 
                     language === 'ta-IN' ? 'родро╛ройро╛роХ роХрпЗроЯрпНроХ роорпБроЯроХрпНроХрокрпНрокроЯрпНроЯродрпБ' : 
                     'Auto-listen disabled') :
                    (language === 'hi-IN' ? 'рдСрдЯреЛ рд▓рд┐рд╕рди рд╕рдХреНрд╖рдо' : 
                     language === 'ta-IN' ? 'родро╛ройро╛роХ роХрпЗроЯрпНроХ роЗропроХрпНроХрокрпНрокроЯрпНроЯродрпБ' : 
                     'Auto-listen enabled')
                  );
                }}
              >
                <div className={`bg-white w-3 h-3 rounded-full transition-transform ${autoListen ? 'translate-x-5' : 'translate-x-0'}`} />
              </div>
            </div>
          </div>

          {/* Main Control Button */}
          <div className="relative">
            <motion.div
              animate={{
                scale: isListening ? [1, 1.2, 1] : 1,
                boxShadow: isListening 
                  ? '0 0 0 0 rgba(239, 68, 68, 0.7)' 
                  : 'none'
              }}
              transition={{
                repeat: isListening ? Infinity : 0,
                duration: 1.5
              }}
              className="absolute inset-0 rounded-full"
            />
            
            <Button
              size="lg"
              onClick={startVoiceInput}
              disabled={isProcessing || isSpeaking}
              className={`gap-3 rounded-full px-10 py-8 text-lg relative z-10 ${
                isListening 
                  ? 'bg-red-500 hover:bg-red-600 animate-pulse shadow-lg' 
                  : 'bg-gradient-to-r from-primary to